<!-- Page Header -->
<div class="page-header">
    <h1 class="greeting">Codebase Memory Manager</h1>
    <p class="greeting-sub">Manage your indexed codebases</p>
</div>

<!-- Alert Messages -->
{{#if message}}
<div class="alert alert-{{messageType}}">{{message}}</div>
{{/if}}

<!-- Two Column Layout -->
<div class="two-col">
    <!-- Codebases List -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">Codebases</h3>
                <p class="card-subtitle">{{codebases.length}} indexed</p>
            </div>
        </div>
        {{#if codebases.length}}
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Chunks</th>
                    <th>Files</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each codebases}}
                <tr>
                    <td>
                        <a href="/codebase/{{name}}" style="color: var(--accent); font-weight: 500;">
                            {{name}}
                        </a>
                    </td>
                    <td><span class="badge badge-blue">{{chunkCount}}</span></td>
                    <td><span class="badge badge-green">{{fileCount}}</span></td>
                    <td>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="showRenameModal('{{name}}')">
                            Rename
                        </button>
                        <form method="POST" action="/delete" style="display:inline;">
                            <input type="hidden" name="name" value="{{name}}">
                            <button type="submit" class="btn btn-ghost btn-sm" onclick="return confirm('Delete {{name}}? This cannot be undone.')">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
        {{else}}
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; opacity: 0.5; margin-bottom: 1rem;">
                <path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <p>No codebases found</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-secondary);">
                Use the ingest form below to add one
            </p>
        </div>
        {{/if}}
    </div>

    <!-- Search Form -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">Search</h3>
                <p class="card-subtitle">Semantic search across all codebases</p>
            </div>
        </div>
        <form method="POST" action="/search">
            <div class="form-group">
                <label class="form-label">Query</label>
                <input type="text" name="query" class="form-input" placeholder="Search across all codebases..." value="{{searchQuery}}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Max Results</label>
                <select name="maxResults" class="form-input">
                    <option value="10" {{#if (eq maxResults 10)}}selected{{/if}}>10</option>
                    <option value="25" {{#if (eq maxResults 25)}}selected{{/if}}>25</option>
                    <option value="50" {{#if (eq maxResults 50)}}selected{{/if}}>50</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        {{#if searchResults}}
        <div style="margin-top: 1.5rem;">
            <h4 style="font-size: 1rem; margin-bottom: 1rem;">Results ({{searchResults.length}})</h4>
            {{#each searchResults}}
            <div class="search-result">
                <div class="result-header">
                    <code style="font-size: 0.875rem; color: var(--text-primary);">{{filePath}}</code>
                    <span class="badge badge-blue">{{similarity}}%</span>
                </div>
                <div style="margin: 0.5rem 0;">
                    <span class="badge badge-green">{{language}}</span>
                    <span class="badge badge-orange">{{chunkType}}</span>
                    <span style="font-size: 0.8125rem; color: var(--text-secondary); margin-left: 0.5rem;">
                        Lines {{startLine}}-{{endLine}}
                    </span>
                </div>
                <pre style="background: var(--bg-surface); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.875rem;"><code>{{content}}</code></pre>
                <button class="btn btn-ghost btn-sm" onclick="copyToClipboard(this, `{{content}}`)">
                    Copy
                </button>
            </div>
            {{/each}}
        </div>
        {{else}}
        {{#if searchQuery}}
        <div class="empty-state" style="margin-top: 1.5rem;">
            <p>No results found for "{{searchQuery}}"</p>
        </div>
        {{/if}}
        {{/if}}
    </div>
</div>

<!-- Ingest Form -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <div>
            <h3 class="card-title">Ingest New Codebase</h3>
            <p class="card-subtitle">Index a directory for semantic search</p>
        </div>
    </div>
    <form method="POST" action="/ingest">
        <div class="form-group">
            <label class="form-label">Codebase Name</label>
            <input type="text" name="name" class="form-input" placeholder="my-project" pattern="[a-zA-Z0-9-_]+" required>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                Only letters, numbers, hyphens, and underscores
            </p>
        </div>
        <div class="form-group">
            <label class="form-label">Directory Path</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" name="path" id="pathInput" class="form-input" placeholder="/path/to/codebase" required style="flex: 1;">
                <button type="button" class="btn btn-primary" onclick="selectFolder()" id="folderPickerBtn">
                    Browse...
                </button>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;" id="folderPickerHelp">
                Click "Browse..." to select a folder, or enter path manually
            </p>
        </div>
        <button type="submit" class="btn btn-primary">Start Ingestion</button>
    </form>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rename Codebase</h3>
            <button type="button" class="btn btn-ghost" onclick="closeRenameModal()">×</button>
        </div>
        <form method="POST" action="/rename">
            <input type="hidden" name="oldName" id="renameOldName">
            <div class="form-group">
                <label class="form-label">Current Name</label>
                <input type="text" id="renameCurrentName" class="form-input" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">New Name</label>
                <input type="text" name="newName" id="renameNewName" class="form-input" placeholder="new-name" pattern="[a-zA-Z0-9-_]+" required>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                    Only letters, numbers, hyphens, and underscores
                </p>
            </div>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button type="button" class="btn btn-ghost" onclick="closeRenameModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Rename</button>
            </div>
        </form>
    </div>
</div>

<!-- Folder Browser Modal -->
<div id="folderBrowserModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Select Folder</h3>
            <button type="button" class="btn btn-ghost" onclick="closeFolderBrowserModal()">×</button>
        </div>
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--bg-surface); border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; flex-shrink: 0;">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <span id="currentPathDisplay" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Loading...</span>
            </div>
        </div>
        <div id="folderLoadingIndicator" style="display: none; text-align: center; padding: 1rem; color: var(--text-secondary);">
            Loading folders...
        </div>
        <div id="folderList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem;">
            <!-- Folders will be loaded here -->
        </div>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button type="button" class="btn btn-ghost" onclick="closeFolderBrowserModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="selectCurrentFolder()">Select This Folder</button>
        </div>
    </div>
</div>
